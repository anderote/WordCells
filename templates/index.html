<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>WordCell Game</title>
</head>

<body>
    <div class="main-content">
        <h1>WordCell Game</h1>
        <p>Solve the word-based arithmetic puzzle by entering a word that is close in meaning to the result of the given
            operation.</p>
        <div id="puzzle"></div>
        <div id="puzzle-type"></div>
        <input type="text" id="user-word" placeholder="Enter your answer here">
        <button id="submit-btn" onclick="submitAnswer()">Submit</button>
        <button id="new-puzzle-btn" onclick="generatePuzzle()">New Puzzle</button>
        <div id="timer">Time left: 30s</div>
        <div id="result"></div>
        <div id="score">Your WordCell Score: 0.00</div>
    </div>
    <div class="history">
        <h2>History</h2>
        <ul id="history-list"></ul>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let currentScore = 0;
        let currentResultEmbedding = [];
        let currentPuzzle = '';
        let timer;
        let timeLeft = 30;

        function startTimer() {
            timeLeft = 30;
            $('#timer').text(`Time left: ${timeLeft}s`);
            timer = setInterval(() => {
                timeLeft--;
                $('#timer').text(`Time left: ${timeLeft}s`);
                if (timeLeft === 0) {
                    clearInterval(timer);
                    $('#result').text("Game Over");
                    $('#submit-btn').prop('disabled', true);
                }
            }, 1000);
        }

        function generatePuzzle() {
            clearInterval(timer);
            startTimer();
            $.getJSON('/generate_puzzle', data => {
                $('#puzzle').text(data.puzzle);
                currentResultEmbedding = data.result_embedding;
                currentPuzzle = data.puzzle;

                // Extract the puzzle type and display it with instructions
                const puzzleType = data.puzzle.includes('+') ? data.puzzle.split(' + ')[1] : '';
                let puzzleInstructions = '';
                if (puzzleType.endsWith('ing')) {  // verb
                    puzzleInstructions = 'Enter a word that represents an action related to the given noun.';
                } else {  // adjective
                    puzzleInstructions = 'Enter a word that describes the the two words.';
                }
                $('#puzzle-type').text(`Puzzle Type: ${puzzleType} (${puzzleInstructions})`);
            });
        }

        
        function submitAnswer() {
            clearInterval(timer);
            const userWord = $('#user-word').val();
            $.post('/calculate_similarity', {
                user_word: userWord,
                result_embedding: currentResultEmbedding,
            }, data => {
                if (data.error) {
                    $('#result').text(data.error);
                } else {
                    currentScore += data.similarity;
                    $('#result').text(`Similarity: ${data.similarity}`);
                    $('#score').text(`Your WordCell Score: ${currentScore.toFixed(2)}`);
                    addToHistory(currentPuzzle, userWord, data.similarity);
                    $('#user-word').val('');
                }
            });
        }

        function addToHistory(puzzle, userWord, similarity) {
            const listItem = $('<li>').text(`Puzzle: ${puzzle}, Your Word: ${userWord}, Similarity: ${similarity}`);
            $('#history-list').append(listItem);
        }

        // Initialize the game
        $(document).ready(function () {
            generatePuzzle();
        });
    </script>
</body>

</html>