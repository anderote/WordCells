<!doctype html>
<html lang="en">

<head>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .cursor {
            animation: blink .75s step-end infinite;
            border-right: 1px solid;
            margin-left: 2px;
        }

        @keyframes blink {
            50% {
                border-color: transparent;
            }
        }
    </style>
    <title>WordCell Game</title>
</head>

<body>
    <div class="start-screen">
        <h1>WordCeLLM</h1>
        <p>You are a large language model tasked with predicting the equivalent token based on user input. Type your
            replies into the text box as fast as possible, using "Enter" to submit your reply and "Shift+Enter" to
            receive the next prompt.
        </p>
        <button id="start-btn" style="display: inline-block; margin: 0 auto;">Start</button>
    </div>
    < <div class="main-content" style="display: none;">
        <h1>WordCells</h1>
        <p>Respond to the user prompts and make them happy.<br> Enter = submit answer; Shift+Enter = next prompt.</p>
        <div id="puzzle"></div>
        <input type="text" id="user-word" placeholder="predict equivalent token">
        <button id="submit-button" class="btn btn-primary">reply</button> <button type="button" id="generateBtn">next
            prompt</button>
        <div id="result"></div>
        <div id="score">User Satisfaction</div>
        <p id="correct-answer" class="correct-answer"></p>
        </div>
        <div class="history">
            <ul id="history-list"></ul>
        </div>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
            let currentScore = 0;
            let currentResultEmbedding = [];
            let currentPuzzle = '';
            let currentCorrectAnswer = '';
            let previousCorrectAnswer = '';
            const userInput = document.getElementById('user-word');
            userInput.addEventListener('keydown', handleEnterKey);

            function generatePoem(puzzle_words, user_words) {
                $.post('/generate_poem', {
                    puzzle_words: puzzle_words.join(" + "),
                    user_words: JSON.stringify(user_words),
                }, data => {
                    $('#poem').text(data.poem);
                });
            }

            function generatePoemOnPuzzle(puzzleWords) {
                $.post('/generate_poem_on_puzzle', {
                    puzzle_words: puzzleWords,
                }, data => {
                    $('#poem').text(data.poem);
                });
            }

            function generatePuzzle() {
                if (previousCorrectAnswer) {
                    $("#correct-answer").text("Best previous answer: " + previousCorrectAnswer);
                }
                $.getJSON('/generate_puzzle', data => {
                    $('#puzzle').text(data.puzzle);
                    currentResultEmbedding = data.result_embedding;
                    currentPuzzle = data.puzzle;
                    previousCorrectAnswer = currentCorrectAnswer;
                    currentCorrectAnswer = data.correct_answer;
                    addPromptToHistory(data.puzzle);
                    // Store the correct answer
                    // generatePoemOnPuzzle(data.puzzle);
                });
            }

            function submitAnswer() {
                const userInput = $('#user-word').val();
                const userWords = userInput.split(/[ ,+]+/).filter(Boolean);

                if (userWords === '') {
                    // If empty, generate a new puzzle
                    generatePuzzle();
                } else {

                    $.post('/calculate_similarity', {
                        user_words: JSON.stringify(userWords),
                        puzzle_words: currentPuzzle,
                        result_embedding: currentResultEmbedding,
                    }, data => {
                        if (data.error) {
                            $('#result').text(data.error);
                        } else {
                            currentScore += data.score;
                            $('#result').text(`Similarity: ${data.similarity}`);
                            $('#score').text(`Your WordCell Score: ${currentScore.toFixed(2)}`);
                            addReplyToHistory(userInput, data.similarity);
                        }
                        $('#user-word').val(''); // Clear the text entry box
                    });
                }
            }

            function addPromptToHistory(puzzle) {
                const listItem = $('<li>');
                const textContent = `prompt: ${puzzle}`;
                listItem.css('color', 'white');
                $('#history-list').prepend(listItem);
                typeResult(listItem, textContent, 0);
            }

            function addReplyToHistory(userWord, similarity) {
                const listItem = $('<li>');
                const textContent = `[[cosine projection: ${similarity.toFixed(2)}]] ${userWord}`;
                const color = getColor(similarity);

                listItem.css('color', color)

                $('#history-list li').eq(0).after(listItem);
                // $('#history-list').prepend(listItem);
                typeResult(listItem, textContent, 0);
            }

            function getColor(similarity) {
                if (similarity >= 0.5) {
                    return 'limegreen';
                } else if (similarity >= 0.3) {
                    return 'gray';
                } else {
                    return 'red';
                }
            }


            function typeResult(element, text, index) {
                if (index < text.length) {
                    element.append(text[index]);
                    setTimeout(() => typeResult(element, text, index + 1), 25);
                } else {
                    element.append('<span class="cursor"></span>');
                    setTimeout(() => element.find('.cursor').remove(), 1000);
                }
            }

            function handleEnterKey(event) {
                if (event.keyCode === 13) { // 13 is the keycode for the 'enter' key
                    event.preventDefault(); // Prevent any default behavior (e.g., form submission
                    // If Shift is also pressed, generate a new puzzle
                    if (event.shiftKey) {
                        generatePuzzle();
                    } else {
                        // If only Enter is pressed, submit the answer
                        submitAnswer();
                    }

                }
            }
            // Event listener for the Generate Puzzle button
            document.getElementById("generateBtn").addEventListener("click", function () {
                generatePuzzle();
            });

            // Initialize the game
            $(document).ready(function () {
                $('#start-btn').on('click', function () {
                    $('.start-screen').hide();
                    $('.main-content').show();
                    $("#correct-answer").text('');
                    generatePuzzle();
                });

                // populate correct answer field
                $("#correct-answer").text('');

                // Add an event listener for input keydown
                $("#user-answer").on("keyup", function (event) {
                    // Check if the 'Enter' key is pressed

                });

                // Add a click event listener for the submit button
                $("#submit-button").on("click", function () {
                    submitAnswer();
                });
            });



        </script>
</body>

</html>