<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>WordCell Game</title>
</head>

<body>
    <div class="main-content">
        <h1>WordCells</h1>
        <p>Solve the word-based arithmetic puzzle by entering a word that is close in meaning to the result of the given
            operation.</p>
            <select id="difficulty">
                <option value="2" selected>Easy (2 words)</option>
                <option value="3">Medium (3 words)</option>
                <option value="4">Hard (4 words)</option>
            </select>
        <div id="puzzle"></div>
        <div id="puzzle-type"></div>
        <input type="text" id="user-word" placeholder="Enter your answer here">
        <button id="submit-btn" onclick="submitAnswer()">Submit</button>
        <button id="new-puzzle-btn" onclick="generatePuzzle()">New Puzzle</button>
        <div id="timer">Time left: 30s</div>
        <div id="result"></div>
        <div id="score">Your WordCell Score: 0.00</div>
    </div>
    <div class="history">
        <h2>History</h2>
        <ul id="history-list"></ul>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let currentScore = 0;
        let currentResultEmbedding = [];
        let currentPuzzle = '';
        let timer;
        let timeLeft = 30;

        function startTimer() {
            timeLeft = 10;
            $('#timer').text(`Time left: ${timeLeft}s`);
            timer = setInterval(() => {
                timeLeft--;
                $('#timer').text(`Time left: ${timeLeft}s`);
                if (timeLeft === 0) {
                    clearInterval(timer);
                    // Generate a new puzzle without adding the previous puzzle to the history
                    $('#user-word').val('');
                    generatePuzzle();
                }
            }, 1000);
        }

    function generatePoem(puzzle_words, user_words) {
        $.post('/generate_poem', {
            puzzle_words: puzzle_words.join(" + "),
            user_words: JSON.stringify(user_words),
        }, data => {
            $('#poem').text(data.poem);
        });
    }

    function generatePoemOnPuzzle(puzzleWords) {
        $.post('/generate_poem_on_puzzle', {
            puzzle_words: puzzleWords,
        }, data => {
            $('#poem').text(data.poem);
        });
    }

    function generatePuzzle() {
        clearInterval(timer);
        startTimer();
        const difficulty = $('#difficulty').val();
        $.getJSON('/generate_puzzle', {difficulty: difficulty}, data => {
            $('#puzzle').text(data.puzzle);
            currentResultEmbedding = data.result_embedding;
            currentPuzzle = data.puzzle;
        });
        $('#user-word').val('');
    }


    function submitAnswer() {
    clearInterval(timer);
    const userInput = $('#user-word').val();
    const userWords = userInput.split(/[ ,+]+/).filter(Boolean); // Split input by space, comma, or plus sign
    $.post('/calculate_similarity', {
        user_words: JSON.stringify(userWords), // Send the words as a JSON string
        puzzle_words: currentPuzzle, // Send the puzzle words
        result_embedding: currentResultEmbedding,
    }, data => {
        if (data.error) {
            $('#result').text(data.error);
        } else {
            const similarity = data.similarity;
            let scoreChange = 0;
            if (similarity >= 0.5) {
                scoreChange = difficulty - 1;
            } else if (similarity <= -0.2) {
                scoreChange = -difficulty/2;
            }
            currentScore += scoreChange;
            $('#result').text(`Similarity: ${similarity}`);
            $('#score').text(`Your WordCell Score: ${currentScore.toFixed(2)}`);
            addToHistory(currentPuzzle, userInput, similarity, scoreChange);

            if (similarity > 0.5) {
                $('#user-word').removeClass('wrong').addClass('correct');
            } else {
                $('#user-word').removeClass('correct').addClass('wrong');
            }
            setTimeout(() => {
                $('#user-word').removeClass('correct wrong');
            }, 2000);
        }
        // Clear the text entry box and generate a new puzzle
        $('#user-word').val('');
        generatePuzzle();
    });
}



    function addToHistory(puzzle, userWord, similarity, score) {
        const listItem = $('<li>').text(`Puzzle: ${puzzle}, Your Word: ${userWord}, Similarity: ${similarity}, Score: ${score}`);
        $('#history-list').append(listItem);
    }


        // Initialize the game
        $(document).ready(function () {
            generatePuzzle();
        });

        $('#user-word').on('keyup', function(event) {
        if (event.key === 'Enter') {
            submitAnswer();
        }
    });
    </script>
</body>

</html>