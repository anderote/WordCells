<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .cursor {
            animation: blink .75s step-end infinite;
            border-right: 1px solid;
            margin-left: 2px;
        }

        @keyframes blink {
            50% {
                border-color: transparent;
            }
        }
    </style>
    <title>WordCell Game</title>
</head>

<body>
    <div class="start-screen">
        <h1>Welcome to WordCells!</h1>
        <p>In this game, you'll solve word-based arithmetic puzzles by entering a word that is close in meaning to the
            result of the given operation. Press "Start" to begin!</p>
        <button id="start-btn" style="display: inline-block; margin: 0 auto;">Start</button>
    </div>
    < <div class="main-content" style="display: none;">
        <h1>WordCells</h1>
        <p>Solve the word-based arithmetic puzzle by entering a word that is close in meaning to the result of the given
            operation. <br> Enter = submit answer; <br> Shift+Enter = new puzzle.</p>
        <div id="puzzle"></div>
        <input type="text" id="user-word" placeholder="Enter your answer here">
        <button id="submit-button" class="btn btn-primary">Submit</button>
        <div id="result"></div>
        <div id="score">Your WordCell Score: 0.00</div>
        <p id="correct-answer" class="correct-answer"></p>
        </div>
        <div class="poem">
            <h2>Poem</h2>
            <p id="poem"></p>
        </div>
        <div class="history">
            <h2>History</h2>
            <ul id="history-list"></ul>
        </div>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
            let currentScore = 0;
            let currentResultEmbedding = [];
            let currentPuzzle = '';
            let currentCorrectAnswer = '';
            let previousCorrectAnswer = '';
            const userInput = document.getElementById('user-word');
            userInput.addEventListener('keydown', handleEnterKey);

            function generatePoem(puzzle_words, user_words) {
                $.post('/generate_poem', {
                    puzzle_words: puzzle_words.join(" + "),
                    user_words: JSON.stringify(user_words),
                }, data => {
                    $('#poem').text(data.poem);
                });
            }

            function generatePoemOnPuzzle(puzzleWords) {
                $.post('/generate_poem_on_puzzle', {
                    puzzle_words: puzzleWords,
                }, data => {
                    $('#poem').text(data.poem);
                });
            }

            function generatePuzzle() {
                if (previousCorrectAnswer) {
                    $("#correct-answer").text("Best previous answer: " + previousCorrectAnswer);
                }
                $.getJSON('/generate_puzzle', data => {
                    $('#puzzle').text(data.puzzle);
                    currentResultEmbedding = data.result_embedding;
                    currentPuzzle = data.puzzle;
                    previousCorrectAnswer = currentCorrectAnswer;
                    currentCorrectAnswer = data.correct_answer; // Store the correct answer
                    // generatePoemOnPuzzle(data.puzzle);
                });
            }

            function submitAnswer() {
                const userInput = $('#user-word').val();
                const userWords = userInput.split(/[ ,+]+/).filter(Boolean);

                if (userWords === '') {
                    // If empty, generate a new puzzle
                    generatePuzzle();
                } else {


                    $.post('/calculate_similarity', {
                        user_words: JSON.stringify(userWords),
                        puzzle_words: currentPuzzle,
                        result_embedding: currentResultEmbedding,
                    }, data => {
                        if (data.error) {
                            $('#result').text(data.error);
                        } else {
                            currentScore += data.score;
                            $('#result').text(`Similarity: ${data.similarity}`);
                            $('#score').text(`Your WordCell Score: ${currentScore.toFixed(2)}`);
                            addToHistory(currentPuzzle, userInput, data.similarity, data.score, currentCorrectAnswer);
                        }
                        $('#user-word').val(''); // Clear the text entry box
                    });
                }
            }


            function addToHistory(puzzle, userWord, similarity, score, correctAnswer) {
                const listItem = $('<li>');
                const textContent = `Puzzle: ${puzzle}, Your Word: ${userWord}, Similarity: ${similarity}, Score: ${score}`;
                $('#history-list').append(listItem);
                typeResult(listItem, textContent, 0);
            }


            function typeResult(element, text, index) {
                if (index < text.length) {
                    element.append(text[index]);
                    setTimeout(() => typeResult(element, text, index + 1), 50);
                } else {
                    element.append('<span class="cursor"></span>');
                    setTimeout(() => element.find('.cursor').remove(), 1000);
                }
            }

            function handleEnterKey(event) {
                if (event.keyCode === 13) { // 13 is the keycode for the 'enter' key
                    event.preventDefault(); // Prevent any default behavior (e.g., form submission
                    // If Shift is also pressed, generate a new puzzle
                    if (event.shiftKey) {
                        generatePuzzle();
                    } else {
                        // If only Enter is pressed, submit the answer
                        submitAnswer();
                    }

                }
            }

            // Initialize the game
            $(document).ready(function () {
                $('#start-btn').on('click', function () {
                    $('.start-screen').hide();
                    $('.main-content').show();
                    $("#correct-answer").text('');
                    generatePuzzle();
                });

                // populate correct answer field
                $("#correct-answer").text('');

                // Add an event listener for input keydown
                $("#user-answer").on("keyup", function (event) {
                    // Check if the 'Enter' key is pressed

                });

                // Add a click event listener for the submit button
                $("#submit-button").on("click", function () {
                    submitAnswer();
                });
            });



        </script>
</body>

</html>